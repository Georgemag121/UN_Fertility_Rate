---
title: "TFR Kmeans Clustering"
author: "Tana Wuren"
date: "11/19/2018"
output: pdf_document
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library("knitr")
library("ggplot2")
library("tidyverse")
library(openxlsx)
library(tidyverse)
library(lubridate)
library(stats)
library(data.table)
library(gridExtra)
library(class)
library(cluster)
```

## read in data and merge data

```{r}
tfr <- read_csv("tfr_data.csv")
subregion = read_csv("un_subregion.csv")
tfr <- merge(x = tfr, y = subregion[ , -1], by = "ISO.code")
tfr$TimeMid <- as.Date.character(format(date_decimal(tfr$TimeMid), "%Y-%m-%d"))
tfr <- tfr %>% mutate(year = year(TimeMid)) %>% filter(year <= 2016)
# head(tfr)
```

## clean up dataset

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
df <- tfr %>% select(DataValue, Country.or.area, DataProcessType, RecallLag, DataTypeGroupName,  year, development)
dim(df)

#head(df)
#unique(tfr$development)
```

## feature extractions (from 'tfr' data; no covariates used)

```{r}
# feature extraction
df_features <- df%>% group_by(Country.or.area) %>% summarize(total_pt = sum(n()), average_RL = mean(abs(RecallLag)), average_TFR = mean(DataValue), num_Census = sum(DataProcessType == "Census"), num_Survey = sum(DataProcessType == "Survey"), num_Estimate = sum(DataProcessType == "Estimate"), num_Register = sum(DataProcessType == "Register"), num_SRS = sum(DataProcessType == "SRS"), num_Panel = sum(DataProcessType == "Panel"), num_PES = sum(DataProcessType == "PES"), num_Indirect = sum(DataTypeGroupName == "Indirect"), num_Direct = sum(DataTypeGroupName == "Direct"), num_UN = sum(DataTypeGroupName == "UN computed"), num_Unknown = sum(DataTypeGroupName == "Unknown"), num_Undefined = sum(DataTypeGroupName == "Undefined"))

```

## join dataset with features

```{r}
# joins
df_tree <- df %>% select(-DataValue, -DataProcessType, -RecallLag, -DataTypeGroupName, -year) %>% group_by(Country.or.area) 
df_tree <- unique( df_tree[,1:2] )
df_tree <- left_join(x = df_features, y = df_tree, by = "Country.or.area")
```

## Kmeans clustering

```{r}
tree_cluster <- kmeans(df_tree[, 2:16], 3, nstart = 2)
#tree_cluster
```

## visualize clustering

```{r}
tree_cluster$cluster <- as.factor(tree_cluster$cluster)
ggplot(df_tree, aes(total_pt, average_TFR, color = tree_cluster$cluster)) + geom_point() + ggtitle("k-means clustering for country") +
  xlab("Total number of data points for a Country") + ylab("Average TFR of a Country") 
```

